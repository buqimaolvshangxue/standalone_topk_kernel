# 硬件性能因子基准测试对比分析

## 测试配置

| 参数 | 值 |
|------|-----|
| Warmup | 100 iterations |
| Test | 100 iterations |
| Data size | 10 MB |

## 测试平台规格

| 指标 | NVIDIA A40 | KS20 (DL) | 理论比值 |
|------|------------|-----------|----------|
| SM 数量 | 84 | 8 | 10.5x |
| 显存容量 | 45 GB | 32 GB | 1.4x |
| 理论带宽 | 696 GB/s | 102.4 GB/s | 6.8x |
| BF16 算力 (TU) | 149.7 TFLOPS | 18 TFLOPS | 8.3x |
| FP32 算力 (CU) | 37.4 TFLOPS | 1 TFLOPS | 37.4x |

---

## 性能差距排序（全部 21 项指标）

| 排名 | 指标 | A40 | DL | **差距** |
|------|------|-----|-----|----------|
| 1 | Compare/Select | 0.0001 us/op | 0.3926 us/op | **3926x** |
| 2 | `__syncwarp()` | 0.0051 us/op | 0.1702 us/op | **33.4x** |
| 3 | `expf()` | 0.0485 us/op | 1.2587 us/op | **25.9x** |
| 4 | Random Read | 48.0 GB/s | 2.1 GB/s | **22.9x** |
| 5 | Warp Broadcast | 0.0241 us/op | 0.4441 us/op | **18.4x** |
| 6 | Warp Shfl UP | 0.0198 us/op | 0.3154 us/op | **15.9x** |
| 7 | Block=512 | 12.45 us | 189.14 us | **15.2x** |
| 8 | Strided Read | 7.5 GB/s | 0.5 GB/s | **15.0x** |
| 9 | `__syncthreads()` | 0.0199 us/op | 0.2624 us/op | **13.2x** |
| 10 | Block=256 | 7.76 us | 101.32 us | **13.1x** |
| 11 | Warp Shfl XOR | 0.0195 us/op | 0.2068 us/op | **10.6x** |
| 12 | Warp Reduce Max | 0.0195 us/op | 0.2052 us/op | **10.5x** |
| 13 | Block=128 | 5.90 us | 61.92 us | **10.5x** |
| 14 | Warp Reduce Sum | 0.0195 us/op | 0.1975 us/op | **10.1x** |
| 15 | Block=64 | 5.82 us | 44.64 us | **7.7x** |
| 16 | Block=32 | 5.77 us | 37.87 us | **6.6x** |
| 17 | Coalesced Read | 253.8 GB/s | 39.1 GB/s | **6.5x** |
| 18 | Coalesced Copy | 509.2 GB/s | 78.1 GB/s | **6.5x** |
| 19 | Coalesced Write | 479.2 GB/s | 77.3 GB/s | **6.2x** |
| 20 | Minimal RW | 3.98 us | 22.13 us | **5.6x** |
| 21 | Empty Kernel | 3.91 us | 21.61 us | **5.5x** |

**带宽效率**：A40 73.2% (509.2/696) vs DL 76.3% (78.1/102.4) → DL 效率更高

---

## 详细分析

### 1. Compare/Select (3926x) - 极其严重

**原始数据**：
```
A40:   6.97 us 总时间, 0.0001 us/op  → 约 69,700 次操作
DL:  50246.66 us 总时间, 0.3926 us/op → 约 128,000 次操作
差距: 0.3926 / 0.0001 = 3926x
```

**含义**：Compare/Select 是最基本的比较选择操作（如 `a > b ? a : b`）

**可能原因**：
1. **缺乏 predicate 执行**：NVIDIA GPU 使用 predicate 寄存器实现无分支条件执行，DL 可能通过跳转实现
2. **分支预测失败代价极高**：每次条件判断都导致流水线刷新
3. **编译器优化失败**：未能将条件选择编译为高效指令

**影响**：TopK、排序、条件逻辑等**所有涉及比较的算法**

---

### 2. `__syncwarp()` (33.4x)

**原始数据**：
```
A40:  20.28 us 总时间, 0.0051 us/op
DL:  680.69 us 总时间, 0.1702 us/op
差距: 0.1702 / 0.0051 = 33.4x
```

**含义**：同步 warp 内 32 个线程

**可能原因**：缺乏 warp 级 barrier 硬件原语，通过软件模拟

---

### 3. `expf()` (25.9x)

**原始数据**：
```
A40:  48.48 us 总时间, 0.0485 us/op
DL: 1258.73 us 总时间, 1.2587 us/op
差距: 1.2587 / 0.0485 = 25.9x
```

**含义**：计算 e^x

**可能原因**：无专用 SFU (Special Function Unit)，通过软件库模拟

---

### 4. Random Read (22.9x)

**原始数据**：
```
A40:  218.38 us 总时间, 48.0 GB/s
DL:  4911.81 us 总时间, 2.1 GB/s
差距: 48.0 / 2.1 = 22.9x
```

**含义**：随机地址访存

**可能原因**：Cache 容量/效率不足、内存控制器调度差

---

### 5. Warp Broadcast (18.4x)

**原始数据**：
```
A40:  24.09 us 总时间, 0.0241 us/op
DL:  444.11 us 总时间, 0.4441 us/op
差距: 0.4441 / 0.0241 = 18.4x
```

---

### 6. Warp Shfl UP (15.9x)

**原始数据**：
```
A40:  99.13 us 总时间, 0.0198 us/op
DL: 1577.24 us 总时间, 0.3154 us/op
差距: 0.3154 / 0.0198 = 15.9x
```

---

### 7-8. Strided Read (15.0x)

**原始数据**：
```
A40:  10.95 us 总时间, 7.5 GB/s
DL:  154.46 us 总时间, 0.5 GB/s
差距: 7.5 / 0.5 = 15.0x
```

**含义**：跨步访存（非连续访问）

---

### 9. `__syncthreads()` (13.2x)

**原始数据**：
```
A40:  79.40 us 总时间, 0.0199 us/op
DL: 1049.59 us 总时间, 0.2624 us/op
差距: 0.2624 / 0.0199 = 13.2x
```

---

### 10-14. Warp 其他操作 (10.1-10.6x)

| 操作 | A40 (us/op) | DL (us/op) | 差距 |
|------|-------------|------------|------|
| Warp Shfl XOR | 0.0195 | 0.2068 | 10.6x |
| Warp Reduce Max | 0.0195 | 0.2052 | 10.5x |
| Warp Reduce Sum | 0.0195 | 0.1975 | 10.1x |

---

### 15-21. 内存带宽 & 启动开销 (5.5-6.5x)

| 指标 | A40 | DL | 差距 |
|------|-----|-----|------|
| Coalesced Read | 253.8 GB/s | 39.1 GB/s | 6.5x |
| Coalesced Copy | 509.2 GB/s | 78.1 GB/s | 6.5x |
| Coalesced Write | 479.2 GB/s | 77.3 GB/s | 6.2x |
| Empty Kernel | 3.91 us | 21.61 us | 5.5x |
| Minimal RW | 3.98 us | 22.13 us | 5.6x |

---

## Block Size 扩展性

| Block Size | A40 (us) | DL (us) | 差距 |
|------------|----------|---------|------|
| 32 | 5.77 | 37.87 | 6.6x |
| 64 | 5.82 | 44.64 | 7.7x |
| 128 | 5.90 | 61.92 | 10.5x |
| 256 | 7.76 | 101.32 | 13.1x |
| 512 | 12.45 | 189.14 | **15.2x** |

**观察**：Block Size 越大，性能差距越大（6.6x → 15.2x）

---

## 核心结论

### 问题分类

| 类别 | 问题 | 差距范围 |
|------|------|----------|
| **分支/比较** | Compare/Select | **3926x** |
| **硬件原语缺失** | syncwarp、expf、syncthreads | 13-33x |
| **非连续访存** | Random/Strided Read | 15-23x |
| **Warp 操作** | Shuffle、Broadcast、Reduce | 10-18x |
| **Block 扩展性** | 大 Block Size | 10-15x |
| **连续访存** | Coalesced 带宽 | 6.5x |
| **软件栈** | 启动开销 | 5.5x |

### 关键发现

1. **Compare/Select 3926x 是最致命问题**：基础比较操作慢了近 4000 倍
2. **分支/条件执行是核心短板**：可能缺乏 predicate 执行机制
3. **非连续访存问题更严重**：Random (23x) > Strided (15x) > Coalesced (6.5x)
4. **Block Size 扩展性差**：大规模并行时效率下降更快
5. **21 项指标全部是严重问题**：最小差距也是 5.5x
